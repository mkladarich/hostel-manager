<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hostel Manager</title>
    <style>
        :root { --bg: #f4f4f4; --surface: #fff; --primary: #2196F3; --text: #333; }
        body { font-family: sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); }
        
        /* Layout */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--surface); padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .controls { margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap; }
        
        /* Buttons */
        button { padding: 10px 15px; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; background: var(--primary); color: white; }
        button.secondary { background: #757575; }
        button.danger { background: #f44336; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Calendar Grid */
        .calendar-wrapper { overflow-x: auto; background: var(--surface); padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .calendar-table { border-collapse: collapse; width: 100%; min-width: 800px; }
        .calendar-table th, .calendar-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .calendar-table th { background: #eee; position: sticky; left: 0; z-index: 10; }
        .room-row th { background: #e3f2fd; text-align: left; }
        
        /* Booking Visuals */
        .booking-cell { background-color: #bbdefb; cursor: pointer; position: relative; font-size: 0.8em; }
        .booking-cell:hover { background-color: #90caf9; }
        
        /* Modal */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 8px; box-sizing: border-box; }
        
        /* Utility */
        .hidden { display: none !important; }
        .status-bar { font-size: 0.9em; color: #666; margin-top: 5px; }
    </style>
</head>
<body>

    <!-- Auth Screen -->
    <div id="auth-screen" class="container" style="text-align: center; margin-top: 100px;">
        <h1>Hostel Manager</h1>
        <p>Login with the Hostel Gmail account to access the drive.</p>
        <button onclick="handleAuthClick()">Login with Google</button>
    </div>

    <!-- Main App -->
    <div id="app-screen" class="hidden">
        <div class="header">
            <h3>Hostel Calendar</h3>
            <div>
                <span id="user-email" style="margin-right: 10px; font-size: 0.8em;"></span>
                <button class="secondary" onclick="handleSignoutClick()">Signout</button>
            </div>
        </div>

        <div class="container">
            <div class="controls">
                <button onclick="syncData()">üîÑ Sync / Refresh</button>
                <button onclick="openBookingModal()">+ New Booking</button>
                <button onclick="configureRooms()" class="secondary">‚öôÔ∏è Edit Rooms</button>
            </div>
            <div id="status-msg" class="status-bar">Ready</div>

            <div class="calendar-wrapper">
                <table class="calendar-table" id="calendar">
                    <!-- Calendar generated by JS -->
                </table>
            </div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div id="booking-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">New Booking</h2>
            <form id="booking-form">
                <input type="hidden" id="booking-id">
                <div class="form-group">
                    <label>Room</label>
                    <select id="b-room" required></select>
                </div>
                <div class="form-group">
                    <label>Guest Name</label>
                    <input type="text" id="b-name" required>
                </div>
                <div class="form-group">
                    <label>Platform (Booking, Airbnb, etc.)</label>
                    <input type="text" id="b-platform">
                </div>
                <div class="form-group">
                    <label>Dates (In - Out)</label>
                    <div style="display:flex; gap:5px;">
                        <input type="date" id="b-start" required>
                        <input type="date" id="b-end" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Contact</label>
                    <input type="tel" id="b-phone" placeholder="Phone">
                    <input type="email" id="b-email" placeholder="Email" style="margin-top:5px;">
                </div>
                <div class="form-group" id="photo-section">
                    <label>Photos (Max 3)</label>
                    <input type="file" id="b-photos" multiple accept="image/*">
                </div>
                
                <div id="action-buttons" style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit">Save Booking</button>
                    <button type="button" class="secondary" onclick="closeModal()">Cancel</button>
                </div>
                
                <div id="contact-buttons" class="hidden" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 10px;">
                    <a id="btn-call" href="#" style="text-decoration:none;"><button type="button">üìû Call</button></a>
                    <a id="btn-email" href="#" style="text-decoration:none;"><button type="button">üìß Email</button></a>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // --- CONFIGURATION ---
        const CLIENT_ID = 'YOUR_CLIENT_ID'; // <--- PASTE HERE
        const API_KEY = 'AIzaSyD8532gK5ngGyKry-7TACkEf86G5I-r4pQ';     // <--- PASTE HERE
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        // --- APP STATE ---
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let rootFolderId = null;
        let bookingsData = [];
        let roomsData = ["Room 1", "Room 2", "Apartment A"]; // Default

        // --- AUTHENTICATION ---
        function gapiLoaded() {
            gapi.load('client', async () => {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
                gapiInited = true;
                maybeEnableButtons();
            });
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES,
                callback: async (resp) => {
                    if (resp.error) throw resp;
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('app-screen').classList.remove('hidden');
                    await initDriveStructure();
                    await syncData();
                },
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) console.log("Google Libraries Loaded");
        }

        function handleAuthClick() {
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                location.reload();
            }
        }

        // --- DRIVE FILE SYSTEM ---
        async function initDriveStructure() {
            updateStatus("Checking Drive folders...");
            // 1. Find Root Folder
            const q = "mimeType='application/vnd.google-apps.folder' and name='HostelManager_App_Data' and trashed=false";
            const res = await gapi.client.drive.files.list({ q: q, fields: 'files(id, name)' });
            
            if (res.result.files.length > 0) {
                rootFolderId = res.result.files[0].id;
            } else {
                // Create Root
                const fileMetadata = { name: 'HostelManager_App_Data', mimeType: 'application/vnd.google-apps.folder' };
                const folder = await gapi.client.drive.files.create({ resource: fileMetadata, fields: 'id' });
                rootFolderId = folder.result.id;
            }
            // Ensure 'customers' subfolder exists
            await ensureFolderExists('customers', rootFolderId);
        }

        async function ensureFolderExists(name, parentId) {
            const q = `mimeType='application/vnd.google-apps.folder' and name='${name}' and '${parentId}' in parents and trashed=false`;
            const res = await gapi.client.drive.files.list({ q: q, fields: 'files(id)' });
            if (res.result.files.length > 0) return res.result.files[0].id;
            
            const fileMetadata = { name: name, mimeType: 'application/vnd.google-apps.folder', parents: [parentId] };
            const folder = await gapi.client.drive.files.create({ resource: fileMetadata, fields: 'id' });
            return folder.result.id;
        }

        // --- DATA SYNC & BACKUP ---
        async function syncData() {
            updateStatus("Syncing...");
            
            // 1. Run Cleanup Logic (Privacy)
            await runPrivacyCleanup();

            // 2. Fetch CSV
            const fileId = await findFile('bookings.csv');
            if (fileId) {
                const res = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
                bookingsData = parseCSV(res.body);
            } else {
                bookingsData = []; // New setup
            }
            
            renderCalendar();
            updateStatus("Sync Complete");
        }

        async function saveDataToDrive() {
            updateStatus("Saving to Cloud...");
            const csvContent = toCSV(bookingsData);
            
            // Handle Backups
            const mainFileId = await findFile('bookings.csv');
            
            if (mainFileId) {
                // Check timestamp to decide if we update backups
                const fileMeta = await gapi.client.drive.files.get({ fileId: mainFileId, fields: 'modifiedTime' });
                const modTime = new Date(fileMeta.result.modifiedTime);
                const now = new Date();
                const hoursSinceMod = (now - modTime) / 36e5;

                // If > 12 hours, save to _12h
                if (hoursSinceMod > 12) await copyFile(mainFileId, 'bookings_12h.csv');
                // If > 24 hours, save to _1day
                if (hoursSinceMod > 24) await copyFile(mainFileId, 'bookings_1day.csv');

                // Update Main
                await updateFile(mainFileId, csvContent);
            } else {
                // Create New
                await createFile('bookings.csv', csvContent, rootFolderId);
            }
            updateStatus("Saved successfully.");
        }

        // --- PRIVACY CLEANUP ---
        async function runPrivacyCleanup() {
            const now = new Date();
            let changed = false;

            for (let b of bookingsData) {
                if (!b.folderId) continue;
                
                const end = new Date(b.end);
                // Add 24 hours to checkout time
                end.setHours(end.getHours() + 24);

                if (now > end) {
                    console.log(`Deleting data for expired booking: ${b.guestName}`);
                    try {
                        await gapi.client.drive.files.delete({ fileId: b.folderId });
                        b.folderId = ""; // Remove reference
                        b.photos = "EXPIRED"; 
                        changed = true;
                    } catch (e) { console.error("Cleanup error", e); }
                }
            }
            if (changed) await saveDataToDrive();
        }

        // --- BOOKING LOGIC ---
        document.getElementById('booking-form').onsubmit = async (e) => {
            e.preventDefault();
            updateStatus("Processing...");
            
            const isNew = !document.getElementById('booking-id').value;
            const id = isNew ? crypto.randomUUID() : document.getElementById('booking-id').value;
            
            // Photo Upload
            const fileInput = document.getElementById('b-photos');
            let folderId = "";
            
            if (fileInput.files.length > 0) {
                const custParent = await ensureFolderExists('customers', rootFolderId);
                // Random code name folder
                const codeName = Math.random().toString(36).substring(7);
                folderId = await ensureFolderExists(codeName, custParent);
                
                for (let file of fileInput.files) {
                    await uploadFile(file, folderId);
                }
            } else if (!isNew) {
                // Keep old folder ID if editing
                const old = bookingsData.find(b => b.id === id);
                if(old) folderId = old.folderId;
            }

            const booking = {
                id: id,
                room: document.getElementById('b-room').value,
                guestName: document.getElementById('b-name').value,
                platform: document.getElementById('b-platform').value,
                start: document.getElementById('b-start').value,
                end: document.getElementById('b-end').value,
                phone: document.getElementById('b-phone').value,
                email: document.getElementById('b-email').value,
                folderId: folderId
            };

            if (isNew) bookingsData.push(booking);
            else {
                const idx = bookingsData.findIndex(b => b.id === id);
                if(idx !== -1) bookingsData[idx] = booking;
            }

            closeModal();
            renderCalendar();
            await saveDataToDrive();
        };

        // --- UI RENDERING ---
        function renderCalendar() {
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';
            
            // Generate Dates (Next 30 days)
            const today = new Date();
            const dates = [];
            for(let i=0; i<30; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                dates.push(d.toISOString().split('T')[0]);
            }

            // Header Row
            const trHead = document.createElement('tr');
            trHead.innerHTML = '<th>Room</th>' + dates.map(d => `<th>${d.slice(5)}</th>`).join('');
            calendar.appendChild(trHead);

            // Room Rows
            roomsData.forEach(room => {
                const tr = document.createElement('tr');
                tr.className = 'room-row';
                tr.innerHTML = `<th>${room}</th>`;
                
                dates.forEach(date => {
                    // Find booking for this room and date
                    const booking = bookingsData.find(b => 
                        b.room === room && 
                        date >= b.start && 
                        date < b.end // Checkout day is usually free for next guest
                    );

                    const td = document.createElement('td');
                    if (booking) {
                        td.className = 'booking-cell';
                        td.innerText = booking.guestName;
                        td.onclick = () => openBookingModal(booking);
                    }
                    tr.appendChild(td);
                });
                calendar.appendChild(tr);
            });
            
            // Populate Select in Form
            const select = document.getElementById('b-room');
            select.innerHTML = roomsData.map(r => `<option value="${r}">${r}</option>`).join('');
        }

        function openBookingModal(booking = null) {
            const modal = document.getElementById('booking-modal');
            const form = document.getElementById('booking-form');
            const contactBtns = document.getElementById('contact-buttons');
            
            modal.style.display = 'flex';
            modal.classList.remove('hidden');

            if (booking) {
                document.getElementById('modal-title').innerText = "Edit / View Booking";
                document.getElementById('booking-id').value = booking.id;
                document.getElementById('b-room').value = booking.room;
                document.getElementById('b-name').value = booking.guestName;
                document.getElementById('b-platform').value = booking.platform || '';
                document.getElementById('b-start').value = booking.start;
                document.getElementById('b-end').value = booking.end;
                document.getElementById('b-phone').value = booking.phone || '';
                document.getElementById('b-email').value = booking.email || '';
                
                // Show contact buttons
                contactBtns.classList.remove('hidden');
                document.getElementById('btn-call').href = `tel:${booking.phone}`;
                document.getElementById('btn-email').href = `mailto:${booking.email}`;
            } else {
                document.getElementById('modal-title').innerText = "New Booking";
                form.reset();
                document.getElementById('booking-id').value = "";
                contactBtns.classList.add('hidden');
            }
        }

        function closeModal() {
            document.getElementById('booking-modal').style.display = 'none';
        }
        
        function configureRooms() {
            const result = prompt("Enter room names separated by comma:", roomsData.join(","));
            if(result) {
                roomsData = result.split(",").map(s => s.trim());
                renderCalendar();
            }
        }

        // --- HELPERS (CSV & DRIVE API) ---
        function updateStatus(msg) {
            document.getElementById('status-msg').innerText = msg;
        }

        // Basic CSV Parsing (assumes no commas in fields for simplicity, use | as delimiter internally)
        function toCSV(data) {
            const headers = ["id","room","guestName","platform","start","end","phone","email","folderId"];
            const rows = data.map(row => headers.map(fieldName => (row[fieldName] || "").replace(/\|/g, '')).join("|"));
            return [headers.join("|"), ...rows].join("\n");
        }

        function parseCSV(text) {
            const lines = text.trim().split("\n");
            if (lines.length < 2) return [];
            const headers = lines[0].split("|");
            return lines.slice(1).map(line => {
                const values = line.split("|");
                let obj = {};
                headers.forEach((h, i) => obj[h] = values[i]);
                return obj;
            });
        }

        // Drive API Wrappers
        async function findFile(name) {
            const q = `name='${name}' and '${rootFolderId}' in parents and trashed=false`;
            const res = await gapi.client.drive.files.list({ q: q });
            return res.result.files.length > 0 ? res.result.files[0].id : null;
        }

        async function createFile(name, content, parentId) {
            const file = new Blob([content], {type: 'text/csv'});
            const metadata = { name: name, parents: [parentId] };
            const accessToken = gapi.auth.getToken().access_token;
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            form.append('file', file);

            await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                body: form
            });
        }

        async function updateFile(fileId, content) {
            const file = new Blob([content], {type: 'text/csv'});
            const accessToken = gapi.auth.getToken().access_token;
            
            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                method: 'PATCH',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken, 'Content-Type': 'text/csv' }),
                body: file
            });
        }

        async function copyFile(fileId, newName) {
            // First check if target exists, if so delete it (simple overwrite logic)
            const existing = await findFile(newName);
            if(existing) await gapi.client.drive.files.delete({ fileId: existing });
            
            await gapi.client.drive.files.copy({
                fileId: fileId,
                resource: { name: newName, parents: [rootFolderId] }
            });
        }

        async function uploadFile(fileObj, parentId) {
            const metadata = { name: fileObj.name, parents: [parentId] };
            const accessToken = gapi.auth.getToken().access_token;
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            form.append('file', fileObj);

            await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                body: form
            });
        }

    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
